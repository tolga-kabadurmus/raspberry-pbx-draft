#!/bin/bash
#
# Environment Configuration for Asterisk USB/IP Dongle System
# 
# IMPORTANT: Copy this file to env.sh and fill in your actual values
#   cp env.sh.example env.sh
#   nano env.sh
#
# Then load it before starting Docker:
#   source env.sh
#   docker-compose up -d
#
systemctl stop ModemManager
systemctl disable ModemManager
#
apt update && apt install -y linux-modules-extra-$(uname -r)
modprobe vhci-hcd
echo "vhci-hcd" | sudo tee -a /etc/modules
#
iptables -I INPUT 1 -p udp --dport 5060 -j ACCEPT
iptables -I INPUT 1 -p udp --dport 10000:20000 -j ACCEPT
netfilter-persistent save
#
# =============================================================================
# DONGLE CONFIGURATION
# =============================================================================

# IMEI of your first Huawei dongle
# - Find with AT command: AT+CGSN or AT+GSN
# - Or check the sticker on your dongle
# - Format: 15 digits
# - Example: 359999999999999
export IMEI1=35XXXXXXXXXXXXX

# IMEI of your second dongle (if you have multiple dongles)
# - Leave as is if you only have one dongle
# - Uncomment the [dongle1] section in asterisk-config/dongle.template if using
export IMEI2=35XXXXXXXXXXXXX

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Your local network in CIDR notation
# - This is used for SIP endpoint access control
# - Find your network with: ip addr show | grep inet
# - Format: network_address/subnet_mask
# - Examples:
#   - Home network: 192.168.1.0/24
#   - Office network: 10.0.0.0/24
#   - Custom network: 172.16.0.0/16
export LOCAL_NET=192.168.1.0/24

# Public IP address (auto-detected by default)
# - This uses Cloudflare's whoami service to detect your public IP
# - Leave as is unless you need a specific public IP
# - Manual override example: export PUBLIC_IP=203.0.113.1
export PUBLIC_IP=$(dig +short txt ch whoami.cloudflare @1.1.1.1 | tr -d '"')

# =============================================================================
# USB/IP CONFIGURATION
# =============================================================================

# IP address of the USB/IP server (machine with physical dongles)
# - This is the server running the USB/IP daemon
# - Replace with the actual IP of your USB/IP server
# - For testing on same machine: use 'localhost' or '127.0.0.1'
# - For production: use the server's LAN IP (e.g., 192.168.1.100)
export USB_IP=192.168.1.100

# =============================================================================
# ASTERISK CONFIGURATION
# =============================================================================

# Password for SIP extensions
# - This will be used for all SIP endpoints defined in pjsip.template
# - IMPORTANT: Use a strong password!
# - Recommendations:
#   - At least 16 characters
#   - Mix of letters, numbers, and symbols
#   - Avoid common words or patterns
# - Example: export EXTEN_PASS='MyS3cur3P@ssw0rd!2024'
export EXTEN_PASS=your_secure_password_here

# =============================================================================
# OPTIONAL ADVANCED CONFIGURATION
# =============================================================================

# These variables are used internally and generally don't need to be changed

# Asterisk HTTP/Manager port (default: 8088)
# export ASTERISK_HTTP_PORT=8088

# Asterisk AMI port (default: 5038)
# export ASTERISK_AMI_PORT=5038

# SIP port (default: 5060)
# export SIP_PORT=5060

# PJSIP TLS port (default: 5061)
# export PJSIPS_PORT=5061

# =============================================================================
# CONFIGURATION VALIDATION
# =============================================================================

# Uncomment the following to validate configuration on load:
# validate_config() {
#     echo "Validating configuration..."
#     
#     # Check required variables
#     [ -z "$IMEI1" ] && echo "ERROR: IMEI1 not set" && return 1
#     [ -z "$LOCAL_NET" ] && echo "ERROR: LOCAL_NET not set" && return 1
#     [ -z "$USB_IP" ] && echo "ERROR: USB_IP not set" && return 1
#     [ -z "$USB_BIND" ] && echo "ERROR: USB_BIND not set" && return 1
#     [ -z "$EXTEN_PASS" ] && echo "ERROR: EXTEN_PASS not set" && return 1
#     
#     # Check password strength
#     if [ ${#EXTEN_PASS} -lt 12 ]; then
#         echo "WARNING: EXTEN_PASS is less than 12 characters (current: ${#EXTEN_PASS})"
#     fi
#     
#     # Check network connectivity to USB/IP server
#     if ! ping -c 1 "$USB_IP" &> /dev/null; then
#         echo "WARNING: Cannot ping USB/IP server at $USB_IP"
#     fi
#     
#     echo "Configuration validation complete."
# }
# validate_config

# =============================================================================
# NOTES
# =============================================================================

# 1. SECURITY:
#    - Never commit env.sh to version control (it's in .gitignore)
#    - Keep this file secure with proper permissions: chmod 600 env.sh
#    - Use different passwords for production vs development

# 2. FINDING IMEI:
#    - Connect dongle to a Linux machine
#    - Install minicom: sudo apt install minicom
#    - Connect to dongle: sudo minicom -D /dev/ttyUSB0
#    - Send command: AT+CGSN
#    - IMEI will be returned

# 3. TESTING USB/IP CONNECTION:
#    Before starting Asterisk, verify USB/IP works:
#      sudo modprobe vhci-hcd
#      usbip list -r $USB_IP
#    You should see your Huawei dongle listed

# 4. TROUBLESHOOTING:
#    - Check this file is loaded: echo $IMEI1
#    - Reload after changes: source env.sh
#    - View all exports: env | grep -E "IMEI|USB_IP|EXTEN"

# =============================================================================
# End of configuration
# =============================================================================
